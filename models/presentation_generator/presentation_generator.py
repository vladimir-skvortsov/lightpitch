"""
Presentation Generator using LLM to create improved presentations with visual suggestions
"""

import json
import logging
import os
import sys
import time
from typing import Dict, List, Any, Optional
from pptx import Presentation
from pptx.util import Inches, Pt
from pptx.enum.text import PP_ALIGN
from pptx.dml.color import RGBColor

# Add the project root to the path to import other modules
sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..'))

from models.text_editor.openrouter_client import OpenRouterService
from models.presentation_summary.presentation_summarizer import PresentationSummarizer
from .types import ImprovedSlide, ImprovedPresentation, VisualElement, VisualElementType, ChartType

logger = logging.getLogger(__name__)


class PresentationGenerator:
    """
    Generates improved presentations with visual element suggestions using LLM
    """
    
    def __init__(self, model: str = 'anthropic/claude-3.5-haiku'):
        """Initialize with OpenRouter service and presentation summarizer"""
        self.openai_service = OpenRouterService(model=model)
        self.summarizer = PresentationSummarizer(model=model)
        
        # Improvement prompt with visual suggestions
        self.improvement_prompt = """
–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π. –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏, —Å–æ–∑–¥–∞–π —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤.

–ü–†–ê–í–ò–õ–ê –£–õ–£–ß–®–ï–ù–ò–Ø:
1. **–£–±–∏—Ä–∞–π –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º—ã –∏ –ª–∏—à–Ω–∏–µ —Å–ª–æ–≤–∞**: "–≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ", "–∫–∞–∫ –±—ã", "—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ", "–∑–Ω–∞—á–∏—Ç", "–Ω—É", "–≤ –æ–±—â–µ–º"
2. **–ò—Å–ø—Ä–∞–≤–ª—è–π –≥—Ä–∞–º–º–∞—Ç–∏–∫—É –∏ —Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É**: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞–¥–µ–∂–∏, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ, –ª–æ–≥–∏—á–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
3. **–î–µ–ª–∞–π —Ç–µ–∫—Å—Ç—ã –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–º–∏**: –æ–¥–Ω–∞ –º—ã—Å–ª—å –Ω–∞ —Å–ª–∞–π–¥, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
4. **–£–ª—É—á—à–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É**: –ª–æ–≥–∏—á–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ø–æ–Ω—è—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
5. **–î–æ–±–∞–≤–ª—è–π call-to-action**: –≥–¥–µ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ
6. **–ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã**: –¥–∏–∞–≥—Ä–∞–º–º—ã, –≥—Ä–∞—Ñ–∏–∫–∏, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ç–∞–±–ª–∏—Ü—ã, –∏–∫–æ–Ω–∫–∏

–¢–ï–ö–£–©–ê–Ø –ü–†–ï–ó–ï–ù–¢–ê–¶–ò–Ø:
{original_content}

–ê–ù–ê–õ–ò–ó –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
{warnings_errors}

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{{
  "improved_slides": [
    {{
      "slide_number": –Ω–æ–º–µ—Ä_—Å–ª–∞–π–¥–∞,
      "title": "—É–ª—É—á—à–µ–Ω–Ω—ã–π_–∑–∞–≥–æ–ª–æ–≤–æ–∫",
      "content": ["—É–ª—É—á—à–µ–Ω–Ω—ã–π_—Ç–µ–∫—Å—Ç_1", "—É–ª—É—á—à–µ–Ω–Ω—ã–π_—Ç–µ–∫—Å—Ç_2"],
      "bullet_points": ["–ø—É–Ω–∫—Ç_1", "–ø—É–Ω–∫—Ç_2", "–ø—É–Ω–∫—Ç_3"],
      "speaker_notes": "–∑–∞–º–µ—Ç–∫–∏_–¥–ª—è_–¥–æ–∫–ª–∞–¥—á–∏–∫–∞",
      "improvements_applied": ["—á—Ç–æ_–±—ã–ª–æ_—É–ª—É—á—à–µ–Ω–æ"],
      "suggested_visuals": [
        {{
          "element_type": "chart|graph|diagram|image|table|icon|infografic|timeline|flowchart",
          "title": "–Ω–∞–∑–≤–∞–Ω–∏–µ_—ç–ª–µ–º–µ–Ω—Ç–∞",
          "description": "–æ–ø–∏—Å–∞–Ω–∏–µ_—ç–ª–µ–º–µ–Ω—Ç–∞",
          "purpose": "–∑–∞—á–µ–º_–Ω—É–∂–µ–Ω_—ç—Ç–æ—Ç_—ç–ª–µ–º–µ–Ω—Ç",
          "data_suggestion": ["–¥–∞–Ω–Ω—ã–µ_–¥–ª—è_–¥–∏–∞–≥—Ä–∞–º–º—ã"],
          "chart_type": "bar|line|pie|column|area|scatter" (—Ç–æ–ª—å–∫–æ –¥–ª—è charts),
          "position_suggestion": "center|left|right|top|bottom",
          "size_suggestion": "small|medium|large"
        }}
      ]
    }}
  ],
  "improvements_summary": [
    "—Å–ø–∏—Å–æ–∫_–æ—Å–Ω–æ–≤–Ω—ã—Ö_—É–ª—É—á—à–µ–Ω–∏–π"
  ],
  "overall_feedback": "–æ–±—â–∞—è_–æ—Ü–µ–Ω–∫–∞_—É–ª—É—á—à–µ–Ω–∏–π"
}}

–ü–†–ê–í–ò–õ–ê –î–õ–Ø –í–ò–ó–£–ê–õ–¨–ù–´–• –≠–õ–ï–ú–ï–ù–¢–û–í:
- –ü—Ä–µ–¥–ª–∞–≥–∞–π –¥–∏–∞–≥—Ä–∞–º–º—ã –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–π –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–æ –≤—Ä–µ–º–µ–Ω–∏
- –î–æ–±–∞–≤–ª—è–π –¥–∏–∞–≥—Ä–∞–º–º—ã –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ —Å—Ö–µ–º
- –ü—Ä–µ–¥–ª–∞–≥–∞–π —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –†–µ–∫–æ–º–µ–Ω–¥—É–π –∏–∫–æ–Ω–∫–∏ –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–Ω—è—Ç–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫—É –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π
- –î–æ–±–∞–≤–ª—è–π timeline –¥–ª—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é, —á–µ—Ç–∫—É—é –∏ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é.
"""
    
    def extract_analysis_issues(self, analysis: Dict[str, Any]) -> str:
        """Extract warnings and errors from analysis for improvement prompt"""
        issues = []
        
        # Add warnings
        for warning in analysis.get('warnings', []):
            issues.append(f"‚ö†Ô∏è {warning.get('title', '')}: {warning.get('description', '')}")
        
        # Add errors
        for error in analysis.get('errors', []):
            issues.append(f"‚ùå {error.get('title', '')}: {error.get('description', '')}")
        
        # Add recommendations
        for rec in analysis.get('recommendations', []):
            issues.append(f"üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: {rec}")
        
        return "\n".join(issues) if issues else "–û—Å–æ–±—ã—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
    
    def parse_visual_element(self, visual_data: Dict[str, Any]) -> VisualElement:
        """Parse visual element from LLM response"""
        try:
            element_type = VisualElementType(visual_data.get('element_type', 'chart'))
            chart_type = None
            
            if element_type in [VisualElementType.CHART, VisualElementType.GRAPH]:
                chart_type_str = visual_data.get('chart_type')
                if chart_type_str:
                    chart_type = ChartType(chart_type_str)
            
            return VisualElement(
                element_type=element_type,
                title=visual_data.get('title', ''),
                description=visual_data.get('description', ''),
                purpose=visual_data.get('purpose', ''),
                data_suggestion=visual_data.get('data_suggestion', []),
                chart_type=chart_type,
                position_suggestion=visual_data.get('position_suggestion', 'center'),
                size_suggestion=visual_data.get('size_suggestion', 'medium')
            )
        except (ValueError, KeyError) as e:
            logger.warning(f"Error parsing visual element: {str(e)}")
            # Return default visual element
            return VisualElement(
                element_type=VisualElementType.CHART,
                title=visual_data.get('title', '–î–∏–∞–≥—Ä–∞–º–º–∞'),
                description=visual_data.get('description', '–í–∏–∑—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç'),
                purpose=visual_data.get('purpose', '–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö')
            )
    
    async def improve_slide_content(self, original_content: str, analysis_issues: str) -> Dict[str, Any]:
        """Improve slide content using LLM with visual suggestions"""
        try:
            prompt = self.improvement_prompt.format(
                original_content=original_content,
                warnings_errors=analysis_issues
            )
            
            logger.info("Improving presentation content with visual suggestions")
            improved_json = await self.openai_service.analyze_text(
                prompt=prompt,
                text="",
                expect_json=True
            )
            
            improved_data = json.loads(improved_json)
            return improved_data
            
        except Exception as e:
            logger.error(f"Error improving slide content: {str(e)}")
            return {
                'improved_slides': [],
                'improvements_summary': [f'–û—à–∏–±–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è: {str(e)}'],
                'overall_feedback': '–ù–µ —É–¥–∞–ª–æ—Å—å —É–ª—É—á—à–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é'
            }
    
    def create_improved_pptx(self, improved_data: Dict[str, Any], original_file_path: str, output_path: str) -> str:
        """Create improved .pptx file with visual placeholders"""
        try:
            # Create new presentation
            prs = Presentation()
            
            # Set slide size to standard (16:9)
            prs.slide_width = Inches(13.33)
            prs.slide_height = Inches(7.5)
            
            improved_slides = improved_data.get('improved_slides', [])
            
            for slide_data in improved_slides:
                # Add new slide
                slide_layout = prs.slide_layouts[1]  # Title and Content layout
                slide = prs.slides.add_slide(slide_layout)
                
                # Add title
                title_shape = slide.shapes.title
                title_shape.text = slide_data.get('title', '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–∞–π–¥–∞')
                
                # Add content to content placeholder
                content_shape = slide.placeholders[1]
                tf = content_shape.text_frame
                tf.clear()
                
                # Add main content
                content_items = slide_data.get('content', [])
                for i, content in enumerate(content_items):
                    if i == 0:
                        p = tf.paragraphs[0]
                    else:
                        p = tf.add_paragraph()
                    p.text = content
                    p.font.size = Pt(18)
                    p.font.color.rgb = RGBColor(51, 51, 51)
                
                # Add bullet points
                bullet_points = slide_data.get('bullet_points', [])
                if bullet_points:
                    if content_items:  # Add spacing if there's already content
                        p = tf.add_paragraph()
                        p.text = ""
                    
                    for bullet in bullet_points:
                        p = tf.add_paragraph()
                        p.text = bullet
                        p.font.size = Pt(16)
                        p.font.color.rgb = RGBColor(51, 51, 51)
                        p.level = 0
                
                # Add visual suggestions as text placeholders
                suggested_visuals = slide_data.get('suggested_visuals', [])
                if suggested_visuals:
                    p = tf.add_paragraph()
                    p.text = ""
                    
                    p = tf.add_paragraph()
                    p.text = "–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –í–ò–ó–£–ê–õ–¨–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´:"
                    p.font.size = Pt(14)
                    p.font.color.rgb = RGBColor(0, 100, 0)
                    p.font.bold = True
                    
                    for visual in suggested_visuals:
                        p = tf.add_paragraph()
                        p.text = f"‚Ä¢ {visual.get('title', '')}: {visual.get('description', '')}"
                        p.font.size = Pt(12)
                        p.font.color.rgb = RGBColor(0, 100, 0)
                        p.level = 1
                
                # Add speaker notes if available
                speaker_notes = slide_data.get('speaker_notes')
                if speaker_notes:
                    notes_slide = slide.notes_slide
                    notes_text_frame = notes_slide.notes_text_frame
                    notes_text_frame.text = speaker_notes
            
            # Save presentation
            prs.save(output_path)
            logger.info(f"Improved presentation with visual suggestions saved to: {output_path}")
            return output_path
            
        except Exception as e:
            logger.error(f"Error creating improved .pptx: {str(e)}")
            raise
    
    async def generate_improved_presentation(self, original_file_path: str, analysis: Dict[str, Any], output_dir: str = None) -> ImprovedPresentation:
        """
        Generate improved presentation with visual suggestions
        
        Args:
            original_file_path: Path to original .pptx file
            analysis: Analysis results from presentation_summary
            output_dir: Directory to save improved presentation
            
        Returns:
            ImprovedPresentation object with visual suggestions
        """
        try:
            logger.info(f"Generating improved presentation with visual suggestions for: {original_file_path}")
            
            # Parse original presentation
            original_content = self.summarizer.parse_presentation(original_file_path)
            
            # Format original content for LLM
            formatted_content = self.summarizer.format_presentation_for_analysis(original_content)
            
            # Extract analysis issues
            analysis_issues = self.extract_analysis_issues(analysis)
            
            # Improve content with LLM
            improved_data = await self.improve_slide_content(formatted_content, analysis_issues)
            
            # Create improved slides objects with visual elements
            improved_slides = []
            for slide_data in improved_data.get('improved_slides', []):
                # Parse visual elements
                suggested_visuals = []
                for visual_data in slide_data.get('suggested_visuals', []):
                    visual_element = self.parse_visual_element(visual_data)
                    suggested_visuals.append(visual_element)
                
                improved_slide = ImprovedSlide(
                    slide_number=slide_data.get('slide_number', 0),
                    title=slide_data.get('title', ''),
                    content=slide_data.get('content', []),
                    bullet_points=slide_data.get('bullet_points', []),
                    speaker_notes=slide_data.get('speaker_notes'),
                    improvements_applied=slide_data.get('improvements_applied', []),
                    suggested_visuals=suggested_visuals
                )
                improved_slides.append(improved_slide)
            
            # Generate output filename
            original_filename = os.path.basename(original_file_path)
            name, ext = os.path.splitext(original_filename)
            improved_filename = f"{name}_improved{ext}"
            
            # Set output directory
            if output_dir is None:
                output_dir = os.path.dirname(original_file_path)
            
            output_path = os.path.join(output_dir, improved_filename)
            
            # Create improved .pptx file
            self.create_improved_pptx(improved_data, original_file_path, output_path)
            
            # Create improved presentation object
            improved_presentation = ImprovedPresentation(
                original_filename=original_filename,
                improved_filename=improved_filename,
                total_slides=len(improved_slides),
                slides=improved_slides,
                improvements_summary=improved_data.get('improvements_summary', []),
                generation_timestamp=str(int(time.time()))
            )
            
            logger.info(f"Successfully generated improved presentation with visual suggestions: {improved_filename}")
            return improved_presentation
            
        except Exception as e:
            logger.error(f"Error generating improved presentation: {str(e)}")
            raise


async def generate_improved_presentation(original_file_path: str, analysis: Dict[str, Any], output_dir: str = None, model: str = 'anthropic/claude-3.5-haiku') -> ImprovedPresentation:
    """
    Convenience function to generate improved presentation with visual suggestions
    
    Args:
        original_file_path: Path to original .pptx file
        analysis: Analysis results
        output_dir: Output directory
        model: LLM model to use
        
    Returns:
        ImprovedPresentation object with visual suggestions
    """
    try:
        generator = PresentationGenerator(model=model)
        return await generator.generate_improved_presentation(original_file_path, analysis, output_dir)
    except Exception as e:
        logger.error(f"Presentation generation failed: {str(e)}")
        raise
